<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Personal Food Tracker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
            padding-bottom: env(safe-area-inset-bottom);
            overflow-x: hidden;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
            padding-bottom: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 15px;
            padding-top: env(safe-area-inset-top);
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 10px;
        }

        .date-navigation {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }

        .date-display {
            font-size: 14px;
            opacity: 0.9;
            min-width: 200px;
            text-align: center;
        }

        .nav-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            touch-action: manipulation;
        }

        .nav-btn:active {
            background: rgba(255, 255, 255, 0.4);
            transform: scale(0.95);
        }

        .today-btn {
            padding: 10px 16px;
            background: rgba(255, 255, 255, 0.3);
            border: 2px solid white;
            color: white;
            border-radius: 25px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s;
            touch-action: manipulation;
        }

        .today-btn:active {
            background: white;
            color: #667eea;
            transform: scale(0.95);
        }

        .export-btn {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.3);
            border: 2px solid white;
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
            z-index: 100;
            touch-action: manipulation;
        }

        .export-btn:active {
            background: white;
            color: #667eea;
            transform: scale(0.95);
        }

        .user-info {
            position: fixed;
            top: 10px;
            left: 10px;
            color: white;
            font-size: 12px;
            background: rgba(255, 255, 255, 0.2);
            padding: 8px 12px;
            border-radius: 20px;
            z-index: 100;
        }

        .logout-btn {
            margin-left: 8px;
            cursor: pointer;
            color: white;
            text-decoration: underline;
        }

        .stats-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .stat-item {
            text-align: center;
            padding: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            color: white;
            touch-action: manipulation;
        }

        .stat-value {
            font-size: 22px;
            font-weight: bold;
        }

        .stat-label {
            font-size: 10px;
            opacity: 0.9;
            margin-top: 3px;
        }

        .input-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .photo-upload {
            width: 100%;
            padding: 15px;
            border: 2px dashed #667eea;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: background 0.3s;
            margin-bottom: 12px;
            position: relative;
            background: rgba(102, 126, 234, 0.05);
            touch-action: manipulation;
        }

        .photo-upload:active {
            background: rgba(102, 126, 234, 0.1);
            transform: scale(0.98);
        }

        .photo-upload input {
            display: none;
        }

        .analyzing-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            z-index: 10;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .input-group {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }

        .food-input {
            flex: 1;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
            -webkit-appearance: none;
        }

        .food-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 12px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s;
            touch-action: manipulation;
            min-width: 70px;
        }

        .btn:active {
            transform: scale(0.95);
        }

        .btn:disabled {
            opacity: 0.6;
        }

        .meal-sections {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .meal-section {
            margin-bottom: 20px;
        }

        .meal-section:last-child {
            margin-bottom: 0;
        }

        .meal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 2px solid #f0f0f0;
        }

        .meal-title {
            font-size: 17px;
            font-weight: 600;
            color: #333;
        }

        .meal-calories {
            font-size: 14px;
            color: #667eea;
            font-weight: 600;
        }

        .food-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 10px;
            margin-bottom: 8px;
            touch-action: manipulation;
        }

        .food-item:active {
            background: #e9ecef;
        }

        .food-name {
            font-weight: 500;
            color: #333;
            font-size: 14px;
            flex: 1;
            word-break: break-word;
        }

        .food-details {
            display: flex;
            flex-direction: column;
            gap: 4px;
            font-size: 11px;
            color: #666;
            align-items: flex-end;
            min-width: 80px;
        }

        .macro {
            display: flex;
            align-items: center;
            gap: 2px;
        }

        .delete-btn {
            background: #ff6b6b;
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
            font-size: 12px;
            margin-left: 8px;
            touch-action: manipulation;
        }

        .delete-btn:active {
            background: #ff5252;
            transform: scale(0.95);
        }

        .empty-state {
            text-align: center;
            color: #999;
            padding: 15px;
            font-style: italic;
            font-size: 14px;
        }

        .meal-type-selector {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-bottom: 12px;
        }

        .meal-type-btn {
            padding: 10px;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
            touch-action: manipulation;
        }

        .meal-type-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: transparent;
        }

        .meal-type-btn:active {
            transform: scale(0.95);
        }

        .login-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 20px;
        }

        .login-modal.hidden {
            display: none;
        }

        .login-box {
            background: white;
            padding: 25px;
            border-radius: 20px;
            width: 100%;
            max-width: 350px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .login-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            text-align: center;
            color: #333;
        }

        .login-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            margin-bottom: 12px;
            font-size: 16px;
            -webkit-appearance: none;
        }

        .login-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .login-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 10px;
            touch-action: manipulation;
        }

        .login-btn:active {
            transform: scale(0.98);
        }

        .login-toggle {
            text-align: center;
            color: #667eea;
            cursor: pointer;
            font-size: 13px;
        }

        @media (max-width: 380px) {
            .header h1 {
                font-size: 20px;
            }
            
            .date-display {
                font-size: 12px;
                min-width: 150px;
            }
            
            .meal-type-selector {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .food-details {
                font-size: 10px;
            }
        }

        @supports (-webkit-touch-callout: none) {
            .container {
                padding-bottom: 80px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="user-info hidden" id="userInfo">
            <span id="usernameDisplay"></span>
            <span class="logout-btn" onclick="logout()">Logout</span>
        </div>
        <button class="export-btn" onclick="exportToCSV()">üì• Export CSV</button>
        <div class="header">
            <h1>üçΩÔ∏è Food Tracker</h1>
            <div class="date-navigation">
                <button class="nav-btn" onclick="changeDate(-1)">‚Üê</button>
                <div class="date-display" id="dateDisplay">Loading...</div>
                <button class="nav-btn" onclick="changeDate(1)">‚Üí</button>
                <button class="today-btn" onclick="goToToday()">üìÖ Today</button>
            </div>
        </div>

        <div class="stats-card">
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-value" id="totalCalories">0</div>
                    <div class="stat-label">CALORIES</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="totalProtein">0g</div>
                    <div class="stat-label">PROTEIN</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="totalCarbs">0g</div>
                    <div class="stat-label">CARBS</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="totalFat">0g</div>
                    <div class="stat-label">FAT</div>
                </div>
            </div>
        </div>

        <div class="input-section">
            <div class="photo-upload" onclick="document.getElementById('photoInput').click()">
                <input type="file" id="photoInput" accept="image/*" capture="environment" onchange="handlePhotoUpload(this)">
                <div style="font-size: 24px;">üì∏</div>
                <div style="font-size: 14px; font-weight: 600;">Take Photo or Upload</div>
                <div style="font-size: 11px; color: #667eea;">AI analysis available</div>
            </div>
            
            <div class="meal-type-selector">
                <button class="meal-type-btn active" onclick="selectMealType('breakfast', this)">üåÖ Breakfast</button>
                <button class="meal-type-btn" onclick="selectMealType('lunch', this)">‚òÄÔ∏è Lunch</button>
                <button class="meal-type-btn" onclick="selectMealType('dinner', this)">üåô Dinner</button>
                <button class="meal-type-btn" onclick="selectMealType('snacks', this)">üçø Snacks</button>
            </div>

            <div class="input-group">
                <input type="text" class="food-input" id="foodInput" placeholder="e.g., 2 eggs, chicken breast 150g">
                <button class="btn" onclick="addFood()">Add</button>
            </div>
        </div>

        <div class="meal-sections">
            <div class="meal-section">
                <div class="meal-header">
                    <span class="meal-title">üåÖ Breakfast</span>
                    <span class="meal-calories" id="breakfastCals">0 cal</span>
                </div>
                <div id="breakfastItems">
                    <div class="empty-state">No items added</div>
                </div>
            </div>

            <div class="meal-section">
                <div class="meal-header">
                    <span class="meal-title">‚òÄÔ∏è Lunch</span>
                    <span class="meal-calories" id="lunchCals">0 cal</span>
                </div>
                <div id="lunchItems">
                    <div class="empty-state">No items added</div>
                </div>
            </div>

            <div class="meal-section">
                <div class="meal-header">
                    <span class="meal-title">üåô Dinner</span>
                    <span class="meal-calories" id="dinnerCals">0 cal</span>
                </div>
                <div id="dinnerItems">
                    <div class="empty-state">No items added</div>
                </div>
            </div>

            <div class="meal-section">
                <div class="meal-header">
                    <span class="meal-title">üçø Snacks</span>
                    <span class="meal-calories" id="snacksCals">0 cal</span>
                </div>
                <div id="snacksItems">
                    <div class="empty-state">No items added</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Login Modal -->
    <div class="login-modal" id="loginModal">
        <div class="login-box">
            <div class="login-title" id="loginTitle">Login to Food Tracker</div>
            <input type="text" class="login-input" id="usernameInput" placeholder="Username">
            <input type="password" class="login-input" id="passwordInput" placeholder="Password">
            <button class="login-btn" id="loginBtn" onclick="handleAuth()">Login</button>
            <div class="login-toggle" id="loginToggle" onclick="toggleAuthMode()">Don't have an account? Sign up</div>
        </div>
    </div>

    <script>
        // Initialize variables
        let currentDate = new Date();
        let currentMealType = 'breakfast';
        let allData = {};
        let nutritionCache = {};
        let currentUser = null;
        let isSignUp = false;

        // Authentication functions
        async function checkAuth() {
            const savedUsername = localStorage.getItem('foodTrackerUsername');
            if (savedUsername) {
                currentUser = savedUsername;
                document.getElementById('loginModal').classList.add('hidden');
                document.getElementById('userInfo').classList.remove('hidden');
                document.getElementById('usernameDisplay').textContent = `üë§ ${savedUsername}`;
                loadData();
            } else {
                document.getElementById('loginModal').classList.remove('hidden');
            }
        }

        function toggleAuthMode() {
            isSignUp = !isSignUp;
            const title = document.getElementById('loginTitle');
            const btn = document.getElementById('loginBtn');
            const toggle = document.getElementById('loginToggle');
            
            if (isSignUp) {
                title.textContent = 'Sign Up for Food Tracker';
                btn.textContent = 'Sign Up';
                toggle.textContent = 'Already have an account? Login';
            } else {
                title.textContent = 'Login to Food Tracker';
                btn.textContent = 'Login';
                toggle.textContent = "Don't have an account? Sign up";
            }
        }

        async function handleAuth() {
            const username = document.getElementById('usernameInput').value.trim();
            const password = document.getElementById('passwordInput').value;
            
            if (!username || !password) {
                alert('Please enter both username and password');
                return;
            }
            
            if (isSignUp) {
                const users = JSON.parse(localStorage.getItem('foodTrackerUsers') || '{}');
                if (users[username]) {
                    alert('Username already exists! Please choose another.');
                    return;
                }
                
                users[username] = btoa(password);
                localStorage.setItem('foodTrackerUsers', JSON.stringify(users));
                alert('Account created successfully! You can now login.');
                toggleAuthMode();
            } else {
                const users = JSON.parse(localStorage.getItem('foodTrackerUsers') || '{}');
                if (!users[username] || users[username] !== btoa(password)) {
                    alert('Invalid username or password');
                    return;
                }
                
                currentUser = username;
                localStorage.setItem('foodTrackerUsername', username);
                document.getElementById('loginModal').classList.add('hidden');
                document.getElementById('userInfo').classList.remove('hidden');
                document.getElementById('usernameDisplay').textContent = `üë§ ${username}`;
                loadData();
            }
        }

        function logout() {
            currentUser = null;
            localStorage.removeItem('foodTrackerUsername');
            location.reload();
        }

        // Date navigation
        function goToToday() {
            currentDate = new Date();
            updateDateDisplay();
            updateDisplay();
        }

        function changeDate(direction) {
            currentDate.setDate(currentDate.getDate() + direction);
            updateDateDisplay();
            updateDisplay();
        }

        function updateDateDisplay() {
            document.getElementById('dateDisplay').textContent = currentDate.toLocaleDateString('en-US', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
        }

        // Data management
        function loadData() {
            if (!currentUser) return;
            
            const userDataKey = `foodTrackerData_${currentUser}`;
            const stored = localStorage.getItem(userDataKey);
            if (stored) {
                try {
                    allData = JSON.parse(stored);
                } catch (e) {
                    console.error('Error loading data:', e);
                    allData = {};
                }
            }
            
            const cachedNutrition = localStorage.getItem('nutritionCache');
            if (cachedNutrition) {
                try {
                    nutritionCache = JSON.parse(cachedNutrition);
                } catch (e) {
                    nutritionCache = {};
                }
            }
            
            updateDisplay();
        }

        function saveData() {
            if (!currentUser) return;
            
            try {
                const userDataKey = `foodTrackerData_${currentUser}`;
                localStorage.setItem(userDataKey, JSON.stringify(allData));
                localStorage.setItem('nutritionCache', JSON.stringify(nutritionCache));
            } catch (e) {
                console.error('Error saving data:', e);
                alert('Error saving data. Storage may be full.');
            }
        }

        function getTodayData() {
            const dateKey = currentDate.toISOString().split('T')[0];
            if (!allData[dateKey]) {
                allData[dateKey] = {
                    breakfast: [],
                    lunch: [],
                    dinner: [],
                    snacks: []
                };
            }
            return allData[dateKey];
        }

        // Meal type selection
        function selectMealType(type, btn) {
            currentMealType = type;
            document.querySelectorAll('.meal-type-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }

        // Get nutrition from ChatGPT API for accurate macros
        async function getNutritionFromAPI(foodName, quantity = 1) {
            const cacheKey = `${foodName}_${quantity}`;
            
            // Check cache first
            if (nutritionCache[cacheKey]) {
                console.log('Using cached nutrition for:', foodName);
                return nutritionCache[cacheKey];
            }
            
            // Get OpenAI API key
            let apiKey = localStorage.getItem('openai_api_key');
            
            // If no API key stored, prompt for it
            if (!apiKey) {
                apiKey = prompt('Enter your OpenAI API key (starts with sk-):\n\nGet one at: platform.openai.com/api-keys');
                if (apiKey && apiKey.startsWith('sk-')) {
                    localStorage.setItem('openai_api_key', apiKey);
                } else {
                    alert('No API key provided. Using estimated values.');
                    return {
                        calories: 150,
                        protein: 10,
                        carbs: 20,
                        fat: 5
                    };
                }
            }
            
            // Use ChatGPT for accurate macros
            console.log('Asking ChatGPT for macros:', foodName);
            console.log('Using API key:', apiKey.substring(0, 10) + '...');
            
            try {
                const requestBody = {
                    model: 'gpt-3.5-turbo',
                    messages: [
                        {
                            role: 'system',
                            content: 'You are a nutrition database. Respond ONLY with a JSON object containing calories, protein, carbs, and fat. Example: {"calories": 250, "protein": 20, "carbs": 30, "fat": 8}'
                        },
                        {
                            role: 'user',
                            content: `Nutrition facts for ${foodName}:`
                        }
                    ],
                    temperature: 0.3,
                    max_tokens: 100
                };
                
                console.log('Sending request to OpenAI...');
                
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify(requestBody)
                });

                console.log('Response status:', response.status);

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('OpenAI API error details:', errorData);
                    
                    if (response.status === 401) {
                        // Invalid API key
                        localStorage.removeItem('openai_api_key');
                        alert('Invalid API key! Please get a new one from platform.openai.com/api-keys');
                        return {
                            calories: 150,
                            protein: 10,
                            carbs: 20,
                            fat: 5
                        };
                    } else if (response.status === 429) {
                        alert('Rate limit exceeded! Solutions:\n\n1. Wait 1-2 minutes and try again\n2. Check your OpenAI usage at platform.openai.com/usage\n3. Consider upgrading from free tier\n4. Add one food item at a time');
                        // Wait 30 seconds before allowing another attempt
                        setTimeout(() => {
                            console.log('Rate limit cooldown finished');
                        }, 30000);
                    } else if (response.status === 400) {
                        alert('API request error. Check your API key or try again.');
                    }
                    
                    throw new Error(`API error: ${errorData.error?.message || 'Unknown error'}`);
                }

                const data = await response.json();
                console.log('ChatGPT full response:', data);
                
                const content = data.choices[0].message.content.trim();
                console.log('ChatGPT nutrition content:', content);
                
                // Parse JSON response - handle potential formatting issues
                let nutritionJson = content;
                
                // Remove any markdown code blocks if present
                nutritionJson = nutritionJson.replace(/```json\n?/g, '').replace(/```\n?/g, '');
                
                try {
                    const nutrition = JSON.parse(nutritionJson);
                    
                    // Ensure all fields are present and valid
                    const finalNutrition = {
                        calories: Math.round(Number(nutrition.calories) || 150),
                        protein: Math.round((Number(nutrition.protein) || 10) * 10) / 10,
                        carbs: Math.round((Number(nutrition.carbs) || 20) * 10) / 10,
                        fat: Math.round((Number(nutrition.fat) || 5) * 10) / 10
                    };
                    
                    console.log('‚úì Final nutrition from ChatGPT:', finalNutrition);
                    
                    // Cache the result
                    nutritionCache[cacheKey] = finalNutrition;
                    saveData();
                    
                    return finalNutrition;
                    
                } catch (parseError) {
                    console.error('Failed to parse ChatGPT response:', nutritionJson);
                    console.error('Parse error:', parseError);
                    
                    // Try to extract numbers from the response
                    const calorieMatch = content.match(/calories[:\s]+(\d+)/i);
                    const proteinMatch = content.match(/protein[:\s]+(\d+)/i);
                    const carbMatch = content.match(/carbs?[:\s]+(\d+)/i);
                    const fatMatch = content.match(/fat[:\s]+(\d+)/i);
                    
                    if (calorieMatch) {
                        return {
                            calories: parseInt(calorieMatch[1]),
                            protein: proteinMatch ? parseInt(proteinMatch[1]) : 10,
                            carbs: carbMatch ? parseInt(carbMatch[1]) : 20,
                            fat: fatMatch ? parseInt(fatMatch[1]) : 5
                        };
                    }
                    
                    throw parseError;
                }
                
            } catch (error) {
                console.error('ChatGPT API error:', error);
                console.error('Full error details:', error.message);
                
                // Clear the API key if it's invalid
                if (error.message.includes('401') || error.message.includes('Invalid')) {
                    localStorage.removeItem('openai_api_key');
                    alert('API key is invalid or expired. Please enter a new one next time.');
                }
                
                // Return default values on error
                return {
                    calories: 150,
                    protein: 10,
                    carbs: 20,
                    fat: 5
                };
            }
        }

        // FIXED: Add food function
        async function addFood() {
            const foodInput = document.getElementById('foodInput');
            const foodName = foodInput.value.trim();
            
            if (!foodName) {
                alert('Please enter a food item');
                return;
            }
            
            // Disable the button to prevent multiple clicks
            const addBtn = document.querySelector('.btn');
            addBtn.disabled = true;
            addBtn.textContent = 'Adding...';
            
            try {
                const nutrition = await getNutritionFromAPI(foodName);
                
                const todayData = getTodayData();
                todayData[currentMealType].push({
                    name: foodName,
                    calories: nutrition.calories,
                    protein: nutrition.protein,
                    carbs: nutrition.carbs,
                    fat: nutrition.fat
                });
                
                saveData();
                updateDisplay();
                
                // Clear input and reset button
                foodInput.value = '';
                
            } catch (error) {
                console.error('Error adding food:', error);
                alert('Error adding food. Please try again.');
            } finally {
                // Re-enable the button
                addBtn.disabled = false;
                addBtn.textContent = 'Add';
            }
        }

        // FIXED: Delete food function
        function deleteFood(mealType, index) {
            if (confirm('Delete this food item?')) {
                const todayData = getTodayData();
                todayData[mealType].splice(index, 1);
                saveData();
                updateDisplay();
            }
        }

        // FIXED: Edit food function
        function editFood(mealType, index) {
            const todayData = getTodayData();
            const food = todayData[mealType][index];
            
            const newName = prompt('Edit food item:', food.name);
            if (newName && newName.trim() !== food.name) {
                // Get new nutrition data
                getNutritionFromAPI(newName.trim()).then(nutrition => {
                    food.name = newName.trim();
                    food.calories = nutrition.calories;
                    food.protein = nutrition.protein;
                    food.carbs = nutrition.carbs;
                    food.fat = nutrition.fat;
                    
                    saveData();
                    updateDisplay();
                });
            }
        }

        // Clear API key function (for testing)
        function clearApiKey() {
            localStorage.removeItem('openai_api_key');
            console.log('API key cleared. You will be prompted for a new one.');
        }

        // Photo upload with ChatGPT analysis
        async function handlePhotoUpload(input) {
            if (!input.files || !input.files[0]) return;
            
            const file = input.files[0];
            const photoUploadDiv = document.querySelector('.photo-upload');
            
            const reader = new FileReader();
            reader.onload = async function(e) {
                const base64Image = e.target.result.split(',')[1];
                
                photoUploadDiv.innerHTML = `
                    <div class="analyzing-overlay">
                        <div class="spinner"></div>
                        <p style="margin-top: 10px; color: #667eea; font-size: 14px;">Analyzing with AI...</p>
                    </div>
                `;
                
                // Try to analyze with ChatGPT Vision
                const apiKey = localStorage.getItem('openai_api_key');
                
                if (apiKey) {
                    try {
                        const response = await fetch('https://api.openai.com/v1/chat/completions', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${apiKey}`
                            },
                            body: JSON.stringify({
                                model: 'gpt-4o-mini',
                                messages: [
                                    {
                                        role: 'user',
                                        content: [
                                            {
                                                type: 'text',
                                                text: 'List each food item you see with quantities. Be specific. Format: "2 eggs", "1 slice whole wheat toast", etc. Separate items with commas.'
                                            },
                                            {
                                                type: 'image_url',
                                                image_url: {
                                                    url: `data:image/jpeg;base64,${base64Image}`
                                                }
                                            }
                                        ]
                                    }
                                ],
                                max_tokens: 200
                            })
                        });

                        if (response.ok) {
                            const data = await response.json();
                            const items = data.choices[0].message.content.split(',').map(item => item.trim());
                            
                            const todayData = getTodayData();
                            
                            // Get nutrition for each detected item
                            for (const item of items) {
                                if (item) {
                                    const nutrition = await getNutritionFromAPI(item);
                                    todayData[currentMealType].push({
                                        name: item,
                                        calories: nutrition.calories,
                                        protein: nutrition.protein,
                                        carbs: nutrition.carbs,
                                        fat: nutrition.fat
                                    });
                                }
                            }
                            
                            saveData();
                            updateDisplay();
                            
                            // Reset photo upload
                            resetPhotoUpload();
                            
                            alert(`ChatGPT detected and added:\n${items.join('\n')}\n\nTap any item to edit if needed.`);
                        } else {
                            throw new Error('Photo analysis failed');
                        }
                    } catch (error) {
                        console.error('ChatGPT Vision error:', error);
                        resetPhotoUpload();
                        alert('Error analyzing image. Please try typing the food instead.');
                    }
                } else {
                    // No API key - demo mode
                    setTimeout(() => {
                        const demoFoods = [
                            { name: '2 eggs', calories: 144, protein: 12, carbs: 1, fat: 10 },
                            { name: '1 slice toast', calories: 75, protein: 3, carbs: 14, fat: 1 }
                        ];
                        
                        const todayData = getTodayData();
                        demoFoods.forEach(food => {
                            todayData[currentMealType].push(food);
                        });
                        
                        saveData();
                        updateDisplay();
                        resetPhotoUpload();
                        
                        alert('Demo mode: Added sample foods.\n\nFor real AI analysis, add your OpenAI API key.');
                    }, 2000);
                }
            };
            reader.readAsDataURL(file);
        }

        function resetPhotoUpload() {
            document.querySelector('.photo-upload').innerHTML = `
                <input type="file" id="photoInput" accept="image/*" capture="environment" onchange="handlePhotoUpload(this)">
                <div style="font-size: 24px;">üì∏</div>
                <div style="font-size: 14px; font-weight: 600;">Take Photo or Upload</div>
                <div style="font-size: 11px; color: #667eea;">ChatGPT analysis ready</div>
            `;
        }

        // Export to CSV
        function exportToCSV() {
            let csv = 'Date,Meal Type,Food Item,Calories,Protein (g),Carbs (g),Fat (g)\n';
            
            const sortedDates = Object.keys(allData).sort();
            
            sortedDates.forEach(date => {
                const dayData = allData[date];
                ['breakfast', 'lunch', 'dinner', 'snacks'].forEach(mealType => {
                    dayData[mealType].forEach(food => {
                        csv += `${date},${mealType},"${food.name}",${Math.round(food.calories)},${Math.round(food.protein)},${Math.round(food.carbs)},${Math.round(food.fat)}\n`;
                    });
                });
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `food_tracker_export_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            alert('Data exported successfully!');
        }

        // FIXED: Update display function
        function updateDisplay() {
            const todayData = getTodayData();
            let totalCals = 0, totalProtein = 0, totalCarbs = 0, totalFat = 0;

            ['breakfast', 'lunch', 'dinner', 'snacks'].forEach(mealType => {
                const container = document.getElementById(`${mealType}Items`);
                const mealCals = document.getElementById(`${mealType}Cals`);
                
                container.innerHTML = '';
                let mealCalories = 0;

                if (todayData[mealType].length === 0) {
                    container.innerHTML = '<div class="empty-state">No items added</div>';
                } else {
                    todayData[mealType].forEach((food, index) => {
                        mealCalories += food.calories;
                        totalCals += food.calories;
                        totalProtein += food.protein;
                        totalCarbs += food.carbs;
                        totalFat += food.fat;

                        const foodItemDiv = document.createElement('div');
                        foodItemDiv.className = 'food-item';
                        foodItemDiv.onclick = () => editFood(mealType, index);
                        
                        foodItemDiv.innerHTML = `
                            <span class="food-name">${food.name}</span>
                            <div class="food-details">
                                <span class="macro">üî• ${Math.round(food.calories)}</span>
                                <span class="macro">üí™ ${Math.round(food.protein)}g</span>
                                <span class="macro">üåæ ${Math.round(food.carbs)}g</span>
                                <span class="macro">ü•ë ${Math.round(food.fat)}g</span>
                            </div>
                            <button class="delete-btn" onclick="event.stopPropagation(); deleteFood('${mealType}', ${index})">√ó</button>
                        `;
                        
                        container.appendChild(foodItemDiv);
                    });
                }

                mealCals.textContent = `${Math.round(mealCalories)} cal`;
            });

            document.getElementById('totalCalories').textContent = Math.round(totalCals);
            document.getElementById('totalProtein').textContent = Math.round(totalProtein) + 'g';
            document.getElementById('totalCarbs').textContent = Math.round(totalCarbs) + 'g';
            document.getElementById('totalFat').textContent = Math.round(totalFat) + 'g';
        }

        // Enter key support for food input
        document.addEventListener('DOMContentLoaded', function() {
            const foodInput = document.getElementById('foodInput');
            if (foodInput) {
                foodInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        addFood();
                    }
                });
            }
        });

        // Initialize
        updateDateDisplay();
        checkAuth();
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Personal Food Tracker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
            padding-bottom: env(safe-area-inset-bottom);
            overflow-x: hidden;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
            padding-bottom: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 15px;
            padding-top: env(safe-area-inset-top);
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 10px;
        }

        .date-navigation {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }

        .date-display {
            font-size: 14px;
            opacity: 0.9;
            min-width: 200px;
            text-align: center;
        }

        .nav-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            touch-action: manipulation;
        }

        .nav-btn:active {
            background: rgba(255, 255, 255, 0.4);
            transform: scale(0.95);
        }

        .today-btn {
            padding: 10px 16px;
            background: rgba(255, 255, 255, 0.3);
            border: 2px solid white;
            color: white;
            border-radius: 25px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s;
            touch-action: manipulation;
        }

        .today-btn:active {
            background: white;
            color: #667eea;
            transform: scale(0.95);
        }

        .export-btn {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.3);
            border: 2px solid white;
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
            z-index: 100;
            touch-action: manipulation;
        }

        .export-btn:active {
            background: white;
            color: #667eea;
            transform: scale(0.95);
        }

        .user-info {
            position: fixed;
            top: 10px;
            left: 10px;
            color: white;
            font-size: 12px;
            background: rgba(255, 255, 255, 0.2);
            padding: 8px 12px;
            border-radius: 20px;
            z-index: 100;
        }

        .logout-btn {
            margin-left: 8px;
            cursor: pointer;
            color: white;
            text-decoration: underline;
        }

        .stats-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .stat-item {
            text-align: center;
            padding: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            color: white;
            touch-action: manipulation;
        }

        .stat-value {
            font-size: 22px;
            font-weight: bold;
        }

        .stat-label {
            font-size: 10px;
            opacity: 0.9;
            margin-top: 3px;
        }

        .input-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .photo-upload {
            width: 100%;
            padding: 15px;
            border: 2px dashed #667eea;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: background 0.3s;
            margin-bottom: 12px;
            position: relative;
            background: rgba(102, 126, 234, 0.05);
            touch-action: manipulation;
        }

        .photo-upload:active {
            background: rgba(102, 126, 234, 0.1);
            transform: scale(0.98);
        }

        .photo-upload input {
            display: none;
        }

        .analyzing-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            z-index: 10;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .input-group {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }

        .food-input {
            flex: 1;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
            -webkit-appearance: none;
        }

        .food-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 12px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s;
            touch-action: manipulation;
            min-width: 70px;
        }

        .btn:active {
            transform: scale(0.95);
        }

        .btn:disabled {
            opacity: 0.6;
        }

        .meal-sections {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .meal-section {
            margin-bottom: 20px;
        }

        .meal-section:last-child {
            margin-bottom: 0;
        }

        .meal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 2px solid #f0f0f0;
        }

        .meal-title {
            font-size: 17px;
            font-weight: 600;
            color: #333;
        }

        .meal-calories {
            font-size: 14px;
            color: #667eea;
            font-weight: 600;
        }

        .food-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 10px;
            margin-bottom: 8px;
            touch-action: manipulation;
        }

        .food-item:active {
            background: #e9ecef;
        }

        .food-name {
            font-weight: 500;
            color: #333;
            font-size: 14px;
            flex: 1;
            word-break: break-word;
        }

        .food-details {
            display: flex;
            flex-direction: column;
            gap: 4px;
            font-size: 11px;
            color: #666;
            align-items: flex-end;
            min-width: 80px;
        }

        .macro {
            display: flex;
            align-items: center;
            gap: 2px;
        }

        .delete-btn {
            background: #ff6b6b;
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
            font-size: 12px;
            margin-left: 8px;
            touch-action: manipulation;
        }

        .delete-btn:active {
            background: #ff5252;
            transform: scale(0.95);
        }

        .empty-state {
            text-align: center;
            color: #999;
            padding: 15px;
            font-style: italic;
            font-size: 14px;
        }

        .meal-type-selector {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-bottom: 12px;
        }

        .meal-type-btn {
            padding: 10px;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
            touch-action: manipulation;
        }

        .meal-type-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: transparent;
        }

        .meal-type-btn:active {
            transform: scale(0.95);
        }

        .login-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 20px;
        }

        .login-modal.hidden {
            display: none;
        }

        .login-box {
            background: white;
            padding: 25px;
            border-radius: 20px;
            width: 100%;
            max-width: 350px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .login-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            text-align: center;
            color: #333;
        }

        .login-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            margin-bottom: 12px;
            font-size: 16px;
            -webkit-appearance: none;
        }

        .login-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .login-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 10px;
            touch-action: manipulation;
        }

        .login-btn:active {
            transform: scale(0.98);
        }

        .login-toggle {
            text-align: center;
            color: #667eea;
            cursor: pointer;
            font-size: 13px;
        }

        @media (max-width: 380px) {
            .header h1 {
                font-size: 20px;
            }
            
            .date-display {
                font-size: 12px;
                min-width: 150px;
            }
            
            .meal-type-selector {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .food-details {
                font-size: 10px;
            }
        }

        @supports (-webkit-touch-callout: none) {
            .container {
                padding-bottom: 80px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
                <div class="user-info hidden" id="userInfo">
            <span id="usernameDisplay"></span>
            <span class="logout-btn" onclick="logout()">Logout</span>
        </div>
        <button class="export-btn" onclick="exportToCSV()">Export CSV</button>
        <div class="header">
            <h1>Food Tracker</h1>
            <div class="date-navigation">
                <button class="nav-btn" onclick="changeDate(-1)">←</button>
                <div class="date-display" id="dateDisplay">Loading...</div>
                <button class="nav-btn" onclick="changeDate(1)">→</button>
                <button class="today-btn" onclick="goToToday()">Today</button>
            </div>
        </div>

        <div class="stats-card">
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-value" id="totalCalories">0</div>
                    <div class="stat-label">CALORIES</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="totalProtein">0g</div>
                    <div class="stat-label">PROTEIN</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="totalCarbs">0g</div>
                    <div class="stat-label">CARBS</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="totalFat">0g</div>
                    <div class="stat-label">FAT</div>
                </div>
            </div>
        </div>

        <div class="input-section">
            <div class="photo-upload" onclick="document.getElementById('photoInput').click()">
                <input type="file" id="photoInput" accept="image/*" capture="environment" onchange="handlePhotoUpload(this)">
                <div style="font-size: 24px;">📸</div>
                <div style="font-size: 14px; font-weight: 600;">Take Photo or Upload</div>
                <div style="font-size: 11px; color: #667eea;">Google Search nutrition lookup</div>
            </div>
            
            <div class="meal-type-selector">
                <button class="meal-type-btn active" onclick="selectMealType('breakfast', this)">Breakfast</button>
                <button class="meal-type-btn" onclick="selectMealType('lunch', this)">Lunch</button>
                <button class="meal-type-btn" onclick="selectMealType('dinner', this)">Dinner</button>
                <button class="meal-type-btn" onclick="selectMealType('snacks', this)">Snacks</button>
            </div>

            <div class="input-group">
                <input type="text" class="food-input" id="foodInput" placeholder="e.g., 2 eggs, chicken breast 150g">
                <button class="btn" onclick="addFood()">Add</button>
            </div>
        </div>

        <div class="meal-sections">
            <div class="meal-section">
                <div class="meal-header">
                    <span class="meal-title">Breakfast</span>
                    <span class="meal-calories" id="breakfastCals">0 cal</span>
                </div>
                <div id="breakfastItems">
                    <div class="empty-state">No items added</div>
                </div>
            </div>

            <div class="meal-section">
                <div class="meal-header">
                    <span class="meal-title">Lunch</span>
                    <span class="meal-calories" id="lunchCals">0 cal</span>
                </div>
                <div id="lunchItems">
                    <div class="empty-state">No items added</div>
                </div>
            </div>

            <div class="meal-section">
                <div class="meal-header">
                    <span class="meal-title">Dinner</span>
                    <span class="meal-calories" id="dinnerCals">0 cal</span>
                </div>
                <div id="dinnerItems">
                    <div class="empty-state">No items added</div>
                </div>
            </div>

            <div class="meal-section">
                <div class="meal-header">
                    <span class="meal-title">Snacks</span>
                    <span class="meal-calories" id="snacksCals">0 cal</span>
                </div>
                <div id="snacksItems">
                    <div class="empty-state">No items added</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Login Modal -->
    <div class="login-modal" id="loginModal">
        <div class="login-box">
            <div class="login-title" id="loginTitle">Login to Food Tracker</div>
            <input type="text" class="login-input" id="usernameInput" placeholder="Username">
            <input type="password" class="login-input" id="passwordInput" placeholder="Password">
            <button class="login-btn" id="loginBtn" onclick="handleAuth()">Login</button>
            <div class="login-toggle" id="loginToggle" onclick="toggleAuthMode()">Don't have an account? Sign up</div>
        </div>
    </div>

    <script>
        // Initialize variables
        let currentDate = new Date();
        let currentMealType = 'breakfast';
        let allData = {};
        let nutritionCache = {};
        let currentUser = null;
        let isSignUp = false;

        // Authentication functions
        async function checkAuth() {
            const savedUsername = localStorage.getItem('foodTrackerUsername');
            if (savedUsername) {
                currentUser = savedUsername;
                document.getElementById('loginModal').classList.add('hidden');
                document.getElementById('userInfo').classList.remove('hidden');
                document.getElementById('usernameDisplay').textContent = `${savedUsername}`;
                loadData();
            } else {
                document.getElementById('loginModal').classList.remove('hidden');
            }
        }

        function toggleAuthMode() {
            isSignUp = !isSignUp;
            const title = document.getElementById('loginTitle');
            const btn = document.getElementById('loginBtn');
            const toggle = document.getElementById('loginToggle');
            
            if (isSignUp) {
                title.textContent = 'Sign Up for Food Tracker';
                btn.textContent = 'Sign Up';
                toggle.textContent = 'Already have an account? Login';
            } else {
                title.textContent = 'Login to Food Tracker';
                btn.textContent = 'Login';
                toggle.textContent = "Don't have an account? Sign up";
            }
        }

        async function handleAuth() {
            const username = document.getElementById('usernameInput').value.trim();
            const password = document.getElementById('passwordInput').value;
            
            if (!username || !password) {
                alert('Please enter both username and password');
                return;
            }
            
            if (isSignUp) {
                const users = JSON.parse(localStorage.getItem('foodTrackerUsers') || '{}');
                if (users[username]) {
                    alert('Username already exists! Please choose another.');
                    return;
                }
                
                users[username] = btoa(password);
                localStorage.setItem('foodTrackerUsers', JSON.stringify(users));
                alert('Account created successfully! You can now login.');
                toggleAuthMode();
            } else {
                const users = JSON.parse(localStorage.getItem('foodTrackerUsers') || '{}');
                if (!users[username] || users[username] !== btoa(password)) {
                    alert('Invalid username or password');
                    return;
                }
                
                currentUser = username;
                localStorage.setItem('foodTrackerUsername', username);
                document.getElementById('loginModal').classList.add('hidden');
                document.getElementById('userInfo').classList.remove('hidden');
                document.getElementById('usernameDisplay').textContent = `${username}`;
                loadData();
            }
        }

        function logout() {
            currentUser = null;
            localStorage.removeItem('foodTrackerUsername');
            location.reload();
        }

        // Date navigation
        function goToToday() {
            currentDate = new Date();
            updateDateDisplay();
            updateDisplay();
        }

        function changeDate(direction) {
            currentDate.setDate(currentDate.getDate() + direction);
            updateDateDisplay();
            updateDisplay();
        }

        function updateDateDisplay() {
            document.getElementById('dateDisplay').textContent = currentDate.toLocaleDateString('en-US', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
        }

        // Data management
        function loadData() {
            if (!currentUser) return;
            
            const userDataKey = `foodTrackerData_${currentUser}`;
            const stored = localStorage.getItem(userDataKey);
            if (stored) {
                try {
                    allData = JSON.parse(stored);
                } catch (e) {
                    console.error('Error loading data:', e);
                    allData = {};
                }
            }
            
            const cachedNutrition = localStorage.getItem('nutritionCache');
            if (cachedNutrition) {
                try {
                    nutritionCache = JSON.parse(cachedNutrition);
                } catch (e) {
                    nutritionCache = {};
                }
            }
            
            updateDisplay();
        }

        function saveData() {
            if (!currentUser) return;
            
            try {
                const userDataKey = `foodTrackerData_${currentUser}`;
                localStorage.setItem(userDataKey, JSON.stringify(allData));
                localStorage.setItem('nutritionCache', JSON.stringify(nutritionCache));
            } catch (e) {
                console.error('Error saving data:', e);
                alert('Error saving data. Storage may be full.');
            }
        }

        function getTodayData() {
            const dateKey = currentDate.toISOString().split('T')[0];
            if (!allData[dateKey]) {
                allData[dateKey] = {
                    breakfast: [],
                    lunch: [],
                    dinner: [],
                    snacks: []
                };
            }
            return allData[dateKey];
        }

        // Meal type selection
        function selectMealType(type, btn) {
            currentMealType = type;
            document.querySelectorAll('.meal-type-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }

        // Get nutrition from Google Search API
        async function getNutritionFromAPI(foodName, quantity = 1) {
            const cacheKey = `${foodName}_${quantity}`;
            
            // Check cache first
            if (nutritionCache[cacheKey]) {
                console.log('Using cached nutrition for:', foodName);
                return nutritionCache[cacheKey];
            }
            
            // Use your pre-configured Google API credentials
            const googleApiKey = 'AIzaSyAfbeus_WPHytcetzff0i3FM2lqWKQyLPw';
            const searchEngineId = '86d68c6854a7145a8';
            
            // Search Google for nutrition information
            console.log('Searching Google for nutrition info:', foodName);
            
            try {
                const searchQuery = encodeURIComponent(`${foodName} nutrition facts calories protein carbs fat`);
                const searchUrl = `https://www.googleapis.com/customsearch/v1?key=${googleApiKey}&cx=${searchEngineId}&q=${searchQuery}&num=5`;
                
                console.log('Searching Google for:', foodName);
                console.log('Search URL:', searchUrl.replace(googleApiKey, 'API_KEY_HIDDEN'));
                
                const response = await fetch(searchUrl);
                
                console.log('Google API Response Status:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Google API error details:', errorText);
                    
                    if (response.status === 403) {
                        alert('Google API error!\n\nPossible issues:\n1. API quota exceeded (100 searches/day limit)\n2. Custom Search API not enabled\n3. API key restricted\n\nUsing food estimates instead.');
                    } else if (response.status === 400) {
                        alert('Bad request to Google API. Using food estimates instead.');
                    }
                    
                    console.log('Falling back to nutrition estimation');
                    return estimateNutritionFromFoodName(foodName);
                }

                const data = await response.json();
                console.log('Google search results:', data);
                
                if (!data.items || data.items.length === 0) {
                    console.log('No search results returned, using estimation');
                    return estimateNutritionFromFoodName(foodName);
                }
                
                // Extract nutrition information from search results
                const nutrition = extractNutritionFromSearchResults(data, foodName);
                
                console.log('✓ Final nutrition data:', nutrition);
                
                // Cache the result
                nutritionCache[cacheKey] = nutrition;
                saveData();
                
                return nutrition;
                
            } catch (error) {
                console.error('Google Search API error:', error);
                
                // Return estimated values on error
                return estimateNutritionFromFoodName(foodName);
            }
        }

        // Extract nutrition information from Google search results - IMPROVED VERSION
        function extractNutritionFromSearchResults(searchData, foodName) {
            let calories = null, protein = null, carbs = null, fat = null;
            
            if (!searchData.items || searchData.items.length === 0) {
                console.log('No search results found, using estimates');
                return estimateNutritionFromFoodName(foodName);
            }
            
            // Combine all text content from search results
            let allText = '';
            searchData.items.forEach(item => {
                allText += ' ' + (item.title || '') + ' ' + (item.snippet || '');
                // Also check if there's structured data
                if (item.pagemap && item.pagemap.nutritioninformation) {
                    allText += ' ' + JSON.stringify(item.pagemap.nutritioninformation);
                }
            });
            
            console.log('Analyzing text for nutrition data...');
            console.log('Sample text:', allText.substring(0, 300));
            
            // Improved extraction patterns - more comprehensive
            const patterns = {
                calories: [
                    /(\d+)\s*(?:calories?|cal|kcal)(?:\s*per|\/|\s|$)/gi,
                    /(?:calories?|cal|kcal)[\s:]*(\d+)/gi,
                    /energy[\s:]*(\d+)/gi
                ],
                protein: [
                    /(\d+(?:\.\d+)?)\s*g?\s*protein/gi,
                    /protein[\s:]*(\d+(?:\.\d+)?)\s*g?/gi,
                    /(\d+(?:\.\d+)?)\s*g\s*protein/gi
                ],
                carbs: [
                    /(\d+(?:\.\d+)?)\s*g?\s*(?:carbs?|carbohydrates?)/gi,
                    /(?:carbs?|carbohydrates?)[\s:]*(\d+(?:\.\d+)?)\s*g?/gi,
                    /(\d+(?:\.\d+)?)\s*g\s*(?:carbs?|carbohydrates?)/gi
                ],
                fat: [
                    /(\d+(?:\.\d+)?)\s*g?\s*(?:total\s*)?fat/gi,
                    /(?:total\s*)?fat[\s:]*(\d+(?:\.\d+)?)\s*g?/gi,
                    /(\d+(?:\.\d+)?)\s*g\s*(?:total\s*)?fat/gi
                ]
            };
            
            // Try each pattern for each macro
            Object.keys(patterns).forEach(macro => {
                const patternList = patterns[macro];
                
                for (let pattern of patternList) {
                    const matches = allText.matchAll(pattern);
                    for (let match of matches) {
                        const value = parseFloat(match[1]);
                        
                        // Sanity checks for reasonable values
                        if (value > 0) {
                            if (macro === 'calories' && value >= 1 && value <= 2000) {
                                if (!calories || Math.abs(value - estimateCaloriesFromFoodName(foodName)) < Math.abs(calories - estimateCaloriesFromFoodName(foodName))) {
                                    calories = value;
                                }
                            } else if (macro !== 'calories' && value >= 0 && value <= 200) {
                                if (!window[macro] || value > 0) {
                                    switch(macro) {
                                        case 'protein':
                                            if (!protein) protein = value;
                                            break;
                                        case 'carbs':
                                            if (!carbs) carbs = value;
                                            break;
                                        case 'fat':
                                            if (!fat) fat = value;
                                            break;
                                    }
                                }
                            }
                        }
                    }
                    
                    // Break if we found a value for this macro
                    if ((macro === 'calories' && calories) || 
                        (macro === 'protein' && protein) || 
                        (macro === 'carbs' && carbs) || 
                        (macro === 'fat' && fat)) {
                        break;
                    }
                }
            });
            
            console.log('Extracted values:', { calories, protein, carbs, fat });
            
            // If we didn't find enough data, use estimation
            if (!calories || (!protein && !carbs && !fat)) {
                console.log('Insufficient data found, using estimation');
                return estimateNutritionFromFoodName(foodName);
            }
            
            // Fill missing values with estimates based on calories
            if (!protein) protein = Math.round(calories * 0.15 / 4 * 10) / 10;
            if (!carbs) carbs = Math.round(calories * 0.45 / 4 * 10) / 10;
            if (!fat) fat = Math.round(calories * 0.30 / 9 * 10) / 10;
            
            return {
                calories: Math.round(calories),
                protein: Math.round(protein * 10) / 10,
                carbs: Math.round(carbs * 10) / 10,
                fat: Math.round(fat * 10) / 10
            };
        }

        // Enhanced nutrition estimation for common foods
        function estimateNutritionFromFoodName(foodName) {
            const name = foodName.toLowerCase();
            
            // Extract quantity if present
            const quantityMatch = name.match(/(\d+)/);
            const quantity = quantityMatch ? parseInt(quantityMatch[1]) : 1;
            
            let baseCalories = 150;
            let baseProtein = 10;
            let baseCarbs = 20;
            let baseFat = 5;
            
            // Comprehensive food database
            if (name.includes('egg')) {
                baseCalories = 70 * quantity;
                baseProtein = 6 * quantity;
                baseCarbs = 0.5 * quantity;
                baseFat = 5 * quantity;
            } else if (name.includes('oreo')) {
                baseCalories = 53 * quantity; // Per cookie
                baseProtein = 0.5 * quantity;
                baseCarbs = 8 * quantity;
                baseFat = 2.3 * quantity;
            } else if (name.includes('chicken breast')) {
                baseCalories = 165;
                baseProtein = 31;
                baseCarbs = 0;
                baseFat = 3.6;
            } else if (name.includes('apple')) {
                baseCalories = 80 * quantity;
                baseProtein = 0.3 * quantity;
                baseCarbs = 21 * quantity;
                baseFat = 0.2 * quantity;
            } else if (name.includes('banana')) {
                baseCalories = 105 * quantity;
                baseProtein = 1.3 * quantity;
                baseCarbs = 27 * quantity;
                baseFat = 0.4 * quantity;
            } else if (name.includes('rice')) {
                baseCalories = 130 * quantity;
                baseProtein = 2.7 * quantity;
                baseCarbs = 28 * quantity;
                baseFat = 0.3 * quantity;
            } else if (name.includes('bread') || name.includes('toast')) {
                baseCalories = 80 * quantity;
                baseProtein = 4 * quantity;
                baseCarbs = 14 * quantity;
                baseFat = 1 * quantity;
            } else if (name.includes('milk')) {
                baseCalories = 150 * quantity;
                baseProtein = 8 * quantity;
                baseCarbs = 12 * quantity;
                baseFat = 8 * quantity;
            } else if (name.includes('cheese')) {
                baseCalories = 113 * quantity;
                baseProtein = 7 * quantity;
                baseCarbs = 1 * quantity;
                baseFat = 9 * quantity;
            } else if (name.includes('salmon') || name.includes('fish')) {
                baseCalories = 180 * quantity;
                baseProtein = 25 * quantity;
                baseCarbs = 0;
                baseFat = 8 * quantity;
            } else if (name.includes('avocado')) {
                baseCalories = 250 * quantity;
                baseProtein = 3 * quantity;
                baseCarbs = 12 * quantity;
                baseFat = 23 * quantity;
            } else if (name.includes('pasta')) {
                baseCalories = 200 * quantity;
                baseProtein = 7 * quantity;
                baseCarbs = 40 * quantity;
                baseFat = 1 * quantity;
            }
            
            console.log(`Estimated nutrition for "${foodName}":`, {
                calories: Math.round(baseCalories),
                protein: Math.round(baseProtein * 10) / 10,
                carbs: Math.round(baseCarbs * 10) / 10,
                fat: Math.round(baseFat * 10) / 10
            });
            
            return {
                calories: Math.round(baseCalories),
                protein: Math.round(baseProtein * 10) / 10,
                carbs: Math.round(baseCarbs * 10) / 10,
                fat: Math.round(baseFat * 10) / 10
            };
        }

        // FIXED: Add food function
        async function addFood() {
            const foodInput = document.getElementById('foodInput');
            const foodName = foodInput.value.trim();
            
            if (!foodName) {
                alert('Please enter a food item');
                return;
            }
            
            // Disable the button to prevent multiple clicks
            const addBtn = document.querySelector('.btn');
            addBtn.disabled = true;
            addBtn.textContent = 'Adding...';
            
            try {
                const nutrition = await getNutritionFromAPI(foodName);
                
                const todayData = getTodayData();
                todayData[currentMealType].push({
                    name: foodName,
                    calories: nutrition.calories,
                    protein: nutrition.protein,
                    carbs: nutrition.carbs,
                    fat: nutrition.fat
                });
                
                saveData();
                updateDisplay();
                
                // Clear input and reset button
                foodInput.value = '';
                
            } catch (error) {
                console.error('Error adding food:', error);
                alert('Error adding food. Please try again.');
            } finally {
                // Re-enable the button
                addBtn.disabled = false;
                addBtn.textContent = 'Add';
            }
        }

        // FIXED: Delete food function
        function deleteFood(mealType, index) {
            if (confirm('Delete this food item?')) {
                const todayData = getTodayData();
                todayData[mealType].splice(index, 1);
                saveData();
                updateDisplay();
            }
        }

        // FIXED: Edit food function
        function editFood(mealType, index) {
            const todayData = getTodayData();
            const food = todayData[mealType][index];
            
            const newName = prompt('Edit food item:', food.name);
            if (newName && newName.trim() !== food.name) {
                // Get new nutrition data
                getNutritionFromAPI(newName.trim()).then(nutrition => {
                    food.name = newName.trim();
                    food.calories = nutrition.calories;
                    food.protein = nutrition.protein;
                    food.carbs = nutrition.carbs;
                    food.fat = nutrition.fat;
                    
                    saveData();
                    updateDisplay();
                });
            }
        }

        // Clear Google API credentials (for testing)
        function clearGoogleCredentials() {
            localStorage.removeItem('google_api_key');
            localStorage.removeItem('google_search_engine_id');
            console.log('Google credentials cleared. You will be prompted for new ones.');
        }

        // Photo upload with Google Search analysis (simplified)
        async function handlePhotoUpload(input) {
            if (!input.files || !input.files[0]) return;
            
            const file = input.files[0];
            const photoUploadDiv = document.querySelector('.photo-upload');
            
            photoUploadDiv.innerHTML = `
                <div class="analyzing-overlay">
                    <div class="spinner"></div>
                    <p style="margin-top: 10px; color: #667eea; font-size: 14px;">Photo uploaded! Please type what you see...</p>
                </div>
            `;
            
            // Since Google Custom Search can't analyze images directly,
            // we'll prompt the user to describe what they see
            setTimeout(() => {
                resetPhotoUpload();
                const foods = prompt('What food items do you see in the photo?\n\nEnter each item separated by commas:\n(e.g., "2 eggs, 1 slice toast, 1 apple")');
                
                if (foods) {
                    const items = foods.split(',').map(item => item.trim()).filter(item => item);
                    
                    if (items.length > 0) {
                        // Add each item to the current meal
                        const todayData = getTodayData();
                        
                        // Process each item
                        items.forEach(async (item) => {
                            const nutrition = await getNutritionFromAPI(item);
                            todayData[currentMealType].push({
                                name: item,
                                calories: nutrition.calories,
                                protein: nutrition.protein,
                                carbs: nutrition.carbs,
                                fat: nutrition.fat
                            });
                            
                            saveData();
                            updateDisplay();
                        });
                        
                        alert(`Added from photo:\n${items.join('\n')}\n\nNutrition data found via Google Search!`);
                    }
                }
            }, 2000);
        }

        function resetPhotoUpload() {
            document.querySelector('.photo-upload').innerHTML = `
                <input type="file" id="photoInput" accept="image/*" capture="environment" onchange="handlePhotoUpload(this)">
                <div style="font-size: 24px;">📸</div>
                <div style="font-size: 14px; font-weight: 600;">Take Photo or Upload</div>
                <div style="font-size: 11px; color: #667eea;">Google Search ready</div>
            `;
        }

        // Export to CSV
        function exportToCSV() {
            let csv = 'Date,Meal Type,Food Item,Calories,Protein (g),Carbs (g),Fat (g)\n';
            
            const sortedDates = Object.keys(allData).sort();
            
            sortedDates.forEach(date => {
                const dayData = allData[date];
                ['breakfast', 'lunch', 'dinner', 'snacks'].forEach(mealType => {
                    dayData[mealType].forEach(food => {
                        csv += `${date},${mealType},"${food.name}",${Math.round(food.calories)},${Math.round(food.protein)},${Math.round(food.carbs)},${Math.round(food.fat)}\n`;
                    });
                });
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `food_tracker_export_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            alert('Data exported successfully!');
        }

        // FIXED: Update display function
        function updateDisplay() {
            const todayData = getTodayData();
            let totalCals = 0, totalProtein = 0, totalCarbs = 0, totalFat = 0;

            ['breakfast', 'lunch', 'dinner', 'snacks'].forEach(mealType => {
                const container = document.getElementById(`${mealType}Items`);
                const mealCals = document.getElementById(`${mealType}Cals`);
                
                container.innerHTML = '';
                let mealCalories = 0;

                if (todayData[mealType].length === 0) {
                    container.innerHTML = '<div class="empty-state">No items added</div>';
                } else {
                    todayData[mealType].forEach((food, index) => {
                        mealCalories += food.calories;
                        totalCals += food.calories;
                        totalProtein += food.protein;
                        totalCarbs += food.carbs;
                        totalFat += food.fat;

                        const foodItemDiv = document.createElement('div');
                        foodItemDiv.className = 'food-item';
                        foodItemDiv.onclick = () => editFood(mealType, index);
                        
                        foodItemDiv.innerHTML = `
                            <span class="food-name">${food.name}</span>
                            <div class="food-details">
                                <span class="macro">Cal: ${Math.round(food.calories)}</span>
                                <span class="macro">Pro: ${Math.round(food.protein)}g</span>
                                <span class="macro">Carb: ${Math.round(food.carbs)}g</span>
                                <span class="macro">Fat: ${Math.round(food.fat)}g</span>
                            </div>
                            <button class="delete-btn" onclick="event.stopPropagation(); deleteFood('${mealType}', ${index})">×</button>
                        `;
                        
                        container.appendChild(foodItemDiv);
                    });
                }

                mealCals.textContent = `${Math.round(mealCalories)} cal`;
            });

            document.getElementById('totalCalories').textContent = Math.round(totalCals);
            document.getElementById('totalProtein').textContent = Math.round(totalProtein) + 'g';
            document.getElementById('totalCarbs').textContent = Math.round(totalCarbs) + 'g';
            document.getElementById('totalFat').textContent = Math.round(totalFat) + 'g';
        }

        // Enter key support for food input
        document.addEventListener('DOMContentLoaded', function() {
            const foodInput = document.getElementById('foodInput');
            if (foodInput) {
                foodInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        addFood();
                    }
                });
            }
        });

        // Initialize
        updateDateDisplay();
        checkAuth();
    </script>
</body>
</html>
